#!/usr/bin/python3
import smtplib
import sys

target = "127.0.0.1"
port = 25
method = "verify"
userfile = open("users.txt",'r')
#verbose = False
success = False

try:
	if sys.argv[1] == "-v": verbose=True;
	#elif sys.argv[1] == "-h": print("-v verbose \n-h help");
	else: print("invalid parameter\nHelp:\n-v verbose --> optional"); sys.exit(1);
except Exception as e:
	verbose=False

try:
	print("\nTrying to connect to SMTP server...")
	con = smtplib.SMTP() # creamos un objeto de tipo smtp
	result = con.connect(target,port) # definimos un host y un puerto y creamos una conexion
	print("Conection established successfully\n")
	if verbose==True: print(result,"\n")
	# hostname retorna el nombre del hostname. La x solo representa un dato, no tiene un significado especial
	code, hostname = con.docmd('HELO x')
	hostname = str(hostname).split(" ")[0]
	ms = con.docmd('MAIL FROM:enum@'+hostname)
	if verbose==True: print(ms)
except Exception as e:
	print("warning: ", e, "\n")

print("\nEnumerating Users...")
print("-------------------------------------------")
for user in userfile:
	if method == 'verify':
		#vrfy devulve un codigo de estado y un mensaje. 550 no encontrado, 250 si existe
		code,message = con.vrfy(user)
		if verbose==True: print("-user:",user+"-code:",code,"\n-message:",message,"\n")
	if code == 250:
		success=True; print("+ "+user[:-1]+" exist\n")
	else:
		print("+ "+user[:-1]+" doesnt exist\n")
con.close()
